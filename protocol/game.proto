syntax = "proto3";

package infinitepickaxe;

import "google/protobuf/wrappers.proto";

// 메시지 타입 Enum
enum MessageType {
  UNKNOWN = 0;

  // 접속/세션
  HANDSHAKE = 1;
  HANDSHAKE_RESULT = 2;
  HEARTBEAT = 3;
  HEARTBEAT_ACK = 4;

  // 유저 데이터
  USER_DATA_SNAPSHOT = 10;

  // 광물
  MINERAL_LIST_REQUEST = 20;
  MINERAL_LIST_RESPONSE = 21;
  CHANGE_MINERAL_REQUEST = 22;
  CHANGE_MINERAL_RESPONSE = 23;

  // 채굴 (서버 주도 시뮬레이션)
  // MINING_START = 30;  // 제거: 서버가 자동 시작
  // MINING_SYNC = 31;   // 제거: 서버가 시뮬레이션
  MINING_UPDATE = 32;      // 서버 → 클라이언트 (40ms마다)
  MINING_COMPLETE = 33;    // 서버 → 클라이언트 (즉시)

  // 슬롯
  ALL_SLOTS_REQUEST = 40;
  ALL_SLOTS_RESPONSE = 41;
  SLOT_UNLOCK = 42;
  SLOT_UNLOCK_RESULT = 43;

  // 강화
  UPGRADE_REQUEST = 50;
  UPGRADE_RESULT = 51;

  // 미션
  DAILY_MISSIONS_REQUEST = 60;
  DAILY_MISSIONS_RESPONSE = 61;
  MISSION_PROGRESS_UPDATE = 62;
  MISSION_COMPLETE = 63;
  MISSION_COMPLETE_RESULT = 64;
  MISSION_REROLL = 65;
  MISSION_REROLL_RESULT = 66;
  MILESTONE_CLAIM = 67;
  MILESTONE_CLAIM_RESULT = 68;

  // 광고
  AD_WATCH_COMPLETE = 70;
  AD_WATCH_RESULT = 71;

  // 재화
  CURRENCY_UPDATE = 80;

  // 오프라인 보상
  OFFLINE_REWARD_REQUEST = 90;
  OFFLINE_REWARD_RESULT = 91;

  // 에러
  ERROR_NOTIFICATION = 100;
}

// 공통 Envelope: Type으로 메시지 구분
message Envelope {
  MessageType type = 1;

  // oneof를 사용하여 타입별 메시지를 직접 포함
  oneof message {
    HandshakeRequest handshake = 10;
    HandshakeResponse handshake_result = 11;
    Heartbeat heartbeat = 12;
    HeartbeatAck heartbeat_ack = 13;

    UserDataSnapshot user_data_snapshot = 20;

    MineralListRequest mineral_list_request = 30;
    MineralListResponse mineral_list_response = 31;
    ChangeMineralRequest change_mineral_request = 32;
    ChangeMineralResponse change_mineral_response = 33;

    // MiningStart mining_start = 40;  // 제거: 서버 주도 시뮬레이션
    // MiningSync mining_sync = 41;    // 제거: 서버 주도 시뮬레이션
    MiningUpdate mining_update = 42;
    MiningComplete mining_complete = 43;

    AllSlotsRequest all_slots_request = 50;
    AllSlotsResponse all_slots_response = 51;
    SlotUnlock slot_unlock = 52;
    SlotUnlockResult slot_unlock_result = 53;

    UpgradeRequest upgrade_request = 60;
    UpgradeResult upgrade_result = 61;

    DailyMissionsRequest daily_missions_request = 70;
    DailyMissionsResponse daily_missions_response = 71;
    MissionProgressUpdate mission_progress_update = 72;
    MissionComplete mission_complete = 73;
    MissionCompleteResult mission_complete_result = 74;
    MissionReroll mission_reroll = 75;
    MissionRerollResult mission_reroll_result = 76;
    MilestoneClaim milestone_claim = 77;
    MilestoneClaimResult milestone_claim_result = 78;

    AdWatchComplete ad_watch_complete = 80;
    AdWatchResult ad_watch_result = 81;

    CurrencyUpdate currency_update = 90;

    OfflineRewardRequest offline_reward_request = 100;
    OfflineRewardResult offline_reward_result = 101;

    ErrorNotification error_notification = 110;
  }
}

// -------------- 접속 / 세션 --------------

message HandshakeRequest {
  string jwt = 1;
  string client_version = 2;
  string device_id = 3;
}

message PickaxeSlotInfo {
  uint32 slot_index = 1;           // 0-3
  uint32 level = 2;                // 곡괭이 레벨 (0-109)
  uint32 tier = 3;                 // 곡괭이 티어 (1-22)
  uint64 attack_power = 4;         // 공격력
  uint32 attack_speed_x100 = 5;    // 공격속도 * 100 (예: 1.5 APS = 150, 최대 2500)
  uint32 critical_hit_percent = 6; // 크리티컬 확률 * 10000 (예: 500 = 5%, 범위 0-10000)
  uint32 critical_damage = 7;      // 크리티컬 데미지 * 100 (예: 15000 = 150%)
  uint64 dps = 8;                  // 이 슬롯의 DPS (크리티컬 포함 계산)
  uint32 pity_bonus = 9;           // 천장 보너스 (0-10000, basis 10000 = 100%)
  bool is_unlocked = 10;           // 슬롯 해금 여부
}

message AdCounter {
  string ad_type = 1;              // "upgrade_discount", "mission_reroll", "crystal_reward"
  uint32 ad_count = 2;             // 오늘 시청 횟수
  uint32 daily_limit = 3;          // 일일 한도 (옵션)
}

message UserDataSnapshot {
  google.protobuf.UInt64Value gold = 1;
  google.protobuf.UInt32Value crystal = 2;
  repeated bool unlocked_slots = 3;              // [true, true, false, false] 형태
  google.protobuf.UInt32Value current_mineral_id = 4;
  google.protobuf.UInt64Value mineral_hp = 5;
  google.protobuf.UInt64Value mineral_max_hp = 6;

  // 슬롯 정보 (4개)
  repeated PickaxeSlotInfo pickaxe_slots = 7;    // 최대 4개
  uint64 total_dps = 8;                          // 모든 슬롯의 DPS 합계

  google.protobuf.UInt64Value server_time = 9;

  // 광고 카운터 (ad_type별)
  repeated AdCounter ad_counters = 10;

  // 미션 관련
  uint32 current_offline_hours = 11;             // 현재 보유 오프라인 시간(시간 단위)
}

message HandshakeResponse {
  bool success = 1;
  string message = 2;      // 성공/실패 메시지
  UserDataSnapshot snapshot = 3;
}

message Heartbeat {
  uint64 client_time_ms = 1;
}

message HeartbeatAck {
  uint64 server_time_ms = 1;
}

// -------------- 광물 정보 --------------

message MineralListRequest {
  // 빈 요청
}

message MineralInfo {
  uint32 mineral_id = 1;
  string name = 2;              // "약한 돌", "돌", "석탄" 등
  uint64 max_hp = 3;
  uint64 gold_reward = 4;
  string icon_name = 5;         // 아이콘 리소스 이름 (옵션)
}

message MineralListResponse {
  repeated MineralInfo minerals = 1;
}

// 광물 변경 (MineralSelectModal에서 "선택" 버튼)
message ChangeMineralRequest {
  uint32 mineral_id = 1;
}

message ChangeMineralResponse {
  bool success = 1;
  uint32 mineral_id = 2;
  uint64 mineral_hp = 3;        // 새 광물의 현재 HP
  uint64 mineral_max_hp = 4;    // 새 광물의 최대 HP
  string error_code = 5;        // "INVALID_MINERAL" 등
}

// -------------- 채굴 --------------

// 서버 주도 시뮬레이션: 클라이언트는 MiningUpdate만 수신
// MiningStart, MiningSync는 제거됨 (서버가 자동으로 시뮬레이션)

// 개별 곡괭이 공격 이벤트 (40ms 틱 내 발생한 공격)
message PickaxeAttack {
  uint32 slot_index = 1;        // 0-3 (어떤 슬롯이 공격했는지)
  uint64 damage = 2;            // 이 공격으로 입힌 데미지
  bool is_critical = 3;         // 크리티컬 여부 (true면 크리티컬)
}

// 서버 → 클라이언트: 40ms마다 전송되는 채굴 상태 업데이트
message MiningUpdate {
  uint32 mineral_id = 1;
  uint64 current_hp = 2;
  uint64 max_hp = 3;
  repeated PickaxeAttack attacks = 4;  // 이번 틱(40ms)에 발생한 공격들
  uint64 server_timestamp = 5;
}

message MiningComplete {
  uint32 mineral_id = 1;
  uint64 gold_earned = 2;
  uint64 total_gold = 3;
  uint64 mining_count = 4;
  uint32 respawn_time = 5;
  uint64 server_timestamp = 6;
}

// -------------- 슬롯 정보 조회 --------------

// 모든 슬롯 정보 조회 (한번에)
message AllSlotsRequest {
  // 빈 요청
}

message AllSlotsResponse {
  repeated PickaxeSlotInfo slots = 1;  // 최대 4개
  uint64 total_dps = 2;                // 모든 슬롯의 DPS 합계
}

// -------------- 강화 --------------

message UpgradeRequest {
  uint32 slot_index = 1;       // 강화할 슬롯 (1-4)
}

message UpgradeResult {
  bool success = 1;
  uint32 slot_index = 2;
  uint32 new_level = 3;
  uint32 new_tier = 4;                     // 강화 후 티어
  uint64 new_attack_power = 5;             // 강화 후 공격력
  uint32 new_attack_speed_x100 = 6;        // 강화 후 공격속도 * 100
  uint32 new_critical_hit_percent = 7;     // 강화 후 크리티컬 확률 * 10000
  uint32 new_critical_damage = 8;          // 강화 후 크리티컬 데미지 * 100
  uint64 new_dps = 9;                      // 강화 후 이 슬롯의 DPS
  uint64 new_total_dps = 10;               // 강화 후 모든 슬롯의 총 DPS
  uint64 gold_spent = 11;
  uint64 remaining_gold = 12;
  string error_code = 13;
  uint32 base_rate_bp = 14;                // 기본 확률 (basis point 10000)
  uint32 bonus_rate_bp = 15;               // 보너스 확률
  uint32 final_rate_bp = 16;               // 최종 확률
  uint32 pity_bonus = 17;                  // 천장 보너스 (업데이트된 값)
}

// -------------- 미션 --------------

message DailyMissionsRequest {
  // 빈 요청
}

message MissionEntry {
  uint32 slot_no = 1;              // 슬롯 번호 (1-3)
  uint32 mission_id = 2;           // 메타데이터 기반 미션 ID
  string mission_type = 3;         // "mine", "play_time", "upgrade", "gold", "level" 등
  string description = 4;
  uint32 target_value = 5;         // 목표 값
  uint32 current_value = 6;        // 현재 진행도
  uint32 reward_crystal = 7;       // 보상 크리스탈
  string status = 8;               // "active", "completed", "claimed"
  uint64 assigned_at = 9;          // 배정 시간 (Unix timestamp ms)
  uint64 expires_at = 10;          // 만료 시간 (Unix timestamp ms, nullable)
}

message DailyMissionsResponse {
  repeated MissionEntry missions = 1;         // 최대 3개 슬롯
  uint32 completed_count = 2;                 // 오늘 완료된 미션 수
  uint32 reroll_count = 3;                    // 오늘 리롤 사용 횟수
  repeated AdCounter ad_counters = 4;         // 광고 카운터 (옵션)
}

message MissionProgressUpdate {
  uint32 slot_no = 1;              // 슬롯 번호 (1-3)
  uint32 mission_id = 2;           // 메타데이터 기반 미션 ID
  uint32 current_value = 3;        // 현재 진행도
  uint32 target_value = 4;         // 목표 값
  string status = 5;               // "active", "completed", "claimed"
}

message MissionComplete {
  uint32 slot_no = 1;              // 슬롯 번호 (1-3)
}

message MissionCompleteResult {
  bool success = 1;
  uint32 slot_no = 2;              // 슬롯 번호
  uint32 mission_id = 3;           // 메타데이터 기반 미션 ID
  uint32 reward_crystal = 4;       // 보상 크리스탈
  uint32 total_crystal = 5;        // 총 크리스탈
  string error_code = 6;
}

message MissionReroll {
  // 빈 요청
}

message MissionRerollResult {
  bool success = 1;
  repeated MissionEntry rerolled_missions = 2;
  uint32 rerolls_used = 3;
  string error_code = 4;
}

// 마일스톤 보상 수령 (QuestTab)
message MilestoneClaim {
  uint32 milestone_count = 1;  // 3, 5, 7
}

message MilestoneClaimResult {
  bool success = 1;
  uint32 milestone_count = 2;
  uint32 offline_hours_gained = 3;  // 오프라인 보상 시간 증가량
  uint32 total_offline_hours = 4;   // 현재 총 오프라인 보유 시간
  uint32 reward_crystal = 5;        // 이번 수령으로 받은 크리스탈
  uint32 total_crystal = 6;         // 수령 후 총 크리스탈
  string error_code = 7;
}

// -------------- 슬롯 해금 --------------

message SlotUnlock {
  uint32 slot_index = 1;
}

message SlotUnlockResult {
  bool success = 1;
  uint32 slot_index = 2;
  uint32 crystal_spent = 3;
  uint32 remaining_crystal = 4;
  string error_code = 5;
  PickaxeSlotInfo new_slot = 6;   // 해금된 슬롯 정보 (성공 시)
  uint64 total_dps = 7;           // 해금 후 총 DPS
}

// -------------- 광고 시청 --------------

message AdWatchComplete {
  string ad_type = 1;  // "upgrade_discount", "mission_reroll", "crystal_reward"
}

message AdWatchResult {
  bool success = 1;
  string ad_type = 2;                   // "upgrade_discount", "mission_reroll", "crystal_reward"
  uint32 crystal_earned = 3;            // 획득한 크리스탈 (crystal_reward 타입일 경우)
  uint32 total_crystal = 4;
  repeated AdCounter ad_counters = 5;   // 업데이트된 광고 카운터
  string error_code = 6;
}

// -------------- 실시간 재화 동기화 --------------

message CurrencyUpdate {
  google.protobuf.UInt64Value gold = 1;
  google.protobuf.UInt32Value crystal = 2;
  string reason = 3;  // "mining", "upgrade", "ad", "mission", "milestone" 등
}

// -------------- 오프라인 보상 --------------

message OfflineRewardRequest {
  // 빈 요청
}

message OfflineRewardResult {
  uint64 elapsed_seconds = 1;
  uint64 gold_earned = 2;
  uint32 mining_count = 3;
  uint64 total_gold = 4;
}

// -------------- 공통 에러 --------------

message ErrorNotification {
  string error_code = 1;    // AUTH_FAILED, INVALID_PACKET, INSUFFICIENT_GOLD 등
  string message = 2;       // 상세 메시지
}
