syntax = "proto3";

package infinitepickaxe;

import "google/protobuf/wrappers.proto";

// 메시지 타입 Enum
enum MessageType {
  UNKNOWN = 0;

  // 접속/세션
  HANDSHAKE = 1;
  HANDSHAKE_RESULT = 2;
  HEARTBEAT = 3;
  HEARTBEAT_ACK = 4;

  // 유저 데이터
  USER_DATA_SNAPSHOT = 10;

  // 광물
  MINERAL_LIST_REQUEST = 20;
  MINERAL_LIST_RESPONSE = 21;
  CHANGE_MINERAL_REQUEST = 22;
  CHANGE_MINERAL_RESPONSE = 23;

  // 채굴
  MINING_START = 30;
  MINING_SYNC = 31;
  MINING_UPDATE = 32;
  MINING_COMPLETE = 33;

  // 슬롯
  ALL_SLOTS_REQUEST = 40;
  ALL_SLOTS_RESPONSE = 41;
  SLOT_UNLOCK = 42;
  SLOT_UNLOCK_RESULT = 43;

  // 강화
  UPGRADE_REQUEST = 50;
  UPGRADE_RESULT = 51;

  // 미션
  DAILY_MISSIONS_REQUEST = 60;
  DAILY_MISSIONS_RESPONSE = 61;
  MISSION_PROGRESS_UPDATE = 62;
  MISSION_COMPLETE = 63;
  MISSION_COMPLETE_RESULT = 64;
  MISSION_REROLL = 65;
  MISSION_REROLL_RESULT = 66;
  MILESTONE_CLAIM = 67;
  MILESTONE_CLAIM_RESULT = 68;

  // 광고
  AD_WATCH_COMPLETE = 70;
  AD_WATCH_RESULT = 71;

  // 재화
  CURRENCY_UPDATE = 80;

  // 오프라인 보상
  OFFLINE_REWARD_REQUEST = 90;
  OFFLINE_REWARD_RESULT = 91;

  // 에러
  ERROR_NOTIFICATION = 100;
}

// 공통 Envelope: Type으로 메시지 구분
message Envelope {
  MessageType type = 1;

  // oneof를 사용하여 타입별 메시지를 직접 포함
  oneof message {
    HandshakeRequest handshake = 10;
    HandshakeResponse handshake_result = 11;
    Heartbeat heartbeat = 12;
    HeartbeatAck heartbeat_ack = 13;

    UserDataSnapshot user_data_snapshot = 20;

    MineralListRequest mineral_list_request = 30;
    MineralListResponse mineral_list_response = 31;
    ChangeMineralRequest change_mineral_request = 32;
    ChangeMineralResponse change_mineral_response = 33;

    MiningStart mining_start = 40;
    MiningSync mining_sync = 41;
    MiningUpdate mining_update = 42;
    MiningComplete mining_complete = 43;

    AllSlotsRequest all_slots_request = 50;
    AllSlotsResponse all_slots_response = 51;
    SlotUnlock slot_unlock = 52;
    SlotUnlockResult slot_unlock_result = 53;

    UpgradeRequest upgrade_request = 60;
    UpgradeResult upgrade_result = 61;

    DailyMissionsRequest daily_missions_request = 70;
    DailyMissionsResponse daily_missions_response = 71;
    MissionProgressUpdate mission_progress_update = 72;
    MissionComplete mission_complete = 73;
    MissionCompleteResult mission_complete_result = 74;
    MissionReroll mission_reroll = 75;
    MissionRerollResult mission_reroll_result = 76;
    MilestoneClaim milestone_claim = 77;
    MilestoneClaimResult milestone_claim_result = 78;

    AdWatchComplete ad_watch_complete = 80;
    AdWatchResult ad_watch_result = 81;

    CurrencyUpdate currency_update = 90;

    OfflineRewardRequest offline_reward_request = 100;
    OfflineRewardResult offline_reward_result = 101;

    ErrorNotification error_notification = 110;
  }
}

// -------------- 접속 / 세션 --------------

message HandshakeRequest {
  string jwt = 1;
  string client_version = 2;
  string device_id = 3;
}

message PickaxeSlotInfo {
  uint32 slot_index = 1;           // 1-4
  uint32 level = 2;                // 곡괭이 레벨
  uint64 attack_power = 3;         // 공격력
  uint32 attack_speed_x100 = 4;    // 공격속도 * 100 (예: 1.5 APS = 150)
  uint64 dps = 5;                  // 이 슬롯의 DPS = (attack_power * attack_speed_x100) / 100
  bool is_unlocked = 6;            // 슬롯 해금 여부
}

message UserDataSnapshot {
  google.protobuf.UInt64Value gold = 1;
  google.protobuf.UInt32Value crystal = 2;
  repeated bool unlocked_slots = 3;              // [true, true, false, false] 형태
  google.protobuf.UInt32Value current_mineral_id = 4;
  google.protobuf.UInt64Value mineral_hp = 5;
  google.protobuf.UInt64Value mineral_max_hp = 6;

  // 슬롯 정보 (4개)
  repeated PickaxeSlotInfo pickaxe_slots = 7;    // 최대 4개
  uint64 total_dps = 8;                          // 모든 슬롯의 DPS 합계

  google.protobuf.UInt64Value server_time = 9;

  // 미션 관련
  uint32 ads_watched_today = 10;
  uint32 mission_rerolls_used = 11;
  uint32 offline_bonus_hours = 12;
}

message HandshakeResponse {
  bool success = 1;
  string message = 2;      // 성공/실패 메시지
  UserDataSnapshot snapshot = 3;
}

message Heartbeat {
  uint64 client_time_ms = 1;
}

message HeartbeatAck {
  uint64 server_time_ms = 1;
}

// -------------- 광물 정보 --------------

message MineralListRequest {
  // 빈 요청
}

message MineralInfo {
  uint32 mineral_id = 1;
  string name = 2;              // "약한 돌", "돌", "석탄" 등
  uint64 max_hp = 3;
  uint64 gold_reward = 4;
  string icon_name = 5;         // 아이콘 리소스 이름 (옵션)
}

message MineralListResponse {
  repeated MineralInfo minerals = 1;
}

// 광물 변경 (MineralSelectModal에서 "선택" 버튼)
message ChangeMineralRequest {
  uint32 mineral_id = 1;
}

message ChangeMineralResponse {
  bool success = 1;
  uint32 mineral_id = 2;
  uint64 mineral_hp = 3;        // 새 광물의 현재 HP
  uint64 mineral_max_hp = 4;    // 새 광물의 최대 HP
  string error_code = 5;        // "INVALID_MINERAL" 등
}

// -------------- 채굴 --------------

message MiningStart {
  uint32 mineral_id = 1;        // 채굴할 광물 (모든 슬롯이 동일 광물 채굴)
}

message MiningSync {
  uint32 mineral_id = 1;
  uint64 client_hp = 2;
  uint64 client_timestamp = 3;
}

message MiningUpdate {
  uint32 mineral_id = 1;
  uint64 current_hp = 2;
  uint64 max_hp = 3;
  uint64 damage_dealt = 4;      // 이번 틱의 총 데미지
  uint64 total_dps = 5;         // 모든 슬롯의 DPS 합계
  uint64 server_timestamp = 6;
}

message MiningComplete {
  uint32 mineral_id = 1;
  uint64 gold_earned = 2;
  uint64 total_gold = 3;
  uint64 mining_count = 4;
  uint32 respawn_time = 5;
  uint64 server_timestamp = 6;
}

// -------------- 슬롯 정보 조회 --------------

// 모든 슬롯 정보 조회 (한번에)
message AllSlotsRequest {
  // 빈 요청
}

message AllSlotsResponse {
  repeated PickaxeSlotInfo slots = 1;  // 최대 4개
  uint64 total_dps = 2;                // 모든 슬롯의 DPS 합계
}

// -------------- 강화 --------------

message UpgradeRequest {
  uint32 slot_index = 1;       // 강화할 슬롯 (1-4)
}

message UpgradeResult {
  bool success = 1;
  uint32 slot_index = 2;
  uint32 new_level = 3;
  uint64 new_attack_power = 4;        // 강화 후 공격력
  uint32 new_attack_speed_x100 = 5;   // 강화 후 공격속도 * 100
  uint64 new_dps = 6;                 // 강화 후 이 슬롯의 DPS
  uint64 new_total_dps = 7;           // 강화 후 모든 슬롯의 총 DPS
  uint64 gold_spent = 8;
  uint64 remaining_gold = 9;
  string error_code = 10;
  uint32 base_rate_bp = 11;           // 기본 확률 (basis point 10000)
  uint32 bonus_rate_bp = 12;          // 보너스 확률
  uint32 final_rate_bp = 13;          // 최종 확률
  uint32 pity_bonus = 14;             // 천장 보너스
}

// -------------- 미션 --------------

message DailyMissionsRequest {
  // 빈 요청
}

message MissionEntry {
  uint32 mission_id = 1;
  string type = 2;
  string description = 3;
  uint32 required_progress = 4;
  uint32 current_progress = 5;
  uint64 gold_reward = 6;
  bool is_completed = 7;
  bool is_claimed = 8;
}

message DailyMissionsResponse {
  repeated MissionEntry missions = 1;
  uint32 ads_watched_today = 2;
  uint32 mission_rerolls_used = 3;
}

message MissionProgressUpdate {
  uint32 mission_id = 1;
  uint32 current_progress = 2;
  uint32 required_progress = 3;
  bool is_completed = 4;
}

message MissionComplete {
  uint32 mission_id = 1;
}

message MissionCompleteResult {
  bool success = 1;
  uint32 mission_id = 2;
  uint64 gold_reward = 3;
  uint64 total_gold = 4;
  string error_code = 5;
}

message MissionReroll {
  // 빈 요청
}

message MissionRerollResult {
  bool success = 1;
  repeated MissionEntry rerolled_missions = 2;
  uint32 rerolls_used = 3;
  string error_code = 4;
}

// 마일스톤 보상 수령 (QuestTab)
message MilestoneClaim {
  uint32 milestone_count = 1;  // 3, 5, 7
}

message MilestoneClaimResult {
  bool success = 1;
  uint32 milestone_count = 2;
  uint32 offline_hours_gained = 3;  // 오프라인 보상 시간 증가량
  uint32 total_offline_hours = 4;   // 현재 총 오프라인 보상 시간
  string error_code = 5;
}

// -------------- 슬롯 해금 --------------

message SlotUnlock {
  uint32 slot_index = 1;
}

message SlotUnlockResult {
  bool success = 1;
  uint32 slot_index = 2;
  uint32 crystal_spent = 3;
  uint32 remaining_crystal = 4;
  string error_code = 5;
}

// -------------- 광고 시청 --------------

message AdWatchComplete {
  uint32 ad_tier = 1;  // 1, 2, 3
}

message AdWatchResult {
  bool success = 1;
  uint32 ad_tier = 2;
  uint32 crystal_earned = 3;
  uint32 total_crystal = 4;
  uint32 ads_watched_today = 5;
  string error_code = 6;
}

// -------------- 실시간 재화 동기화 --------------

message CurrencyUpdate {
  google.protobuf.UInt64Value gold = 1;
  google.protobuf.UInt32Value crystal = 2;
  string reason = 3;  // "mining", "upgrade", "ad", "mission", "milestone" 등
}

// -------------- 오프라인 보상 --------------

message OfflineRewardRequest {
  // 빈 요청
}

message OfflineRewardResult {
  uint64 elapsed_seconds = 1;
  uint64 gold_earned = 2;
  uint32 mining_count = 3;
  uint64 total_gold = 4;
}

// -------------- 공통 에러 --------------

message ErrorNotification {
  string error_code = 1;    // AUTH_FAILED, INVALID_PACKET, INSUFFICIENT_GOLD 등
  string message = 2;       // 상세 메시지
}
